on:
  push:
    tags:
      - '*.*.*'

jobs:
  build_addon:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y lib32gcc-s1

    - name: Install SteamCMD
      run: |
        mkdir -p ~/steamcmd && cd ~/steamcmd
        curl -sqL https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz | tar zxvf -
        ./steamcmd.sh +quit

    - name: Create Steam config directory
      run: |
        mkdir -p ~/.steam/sdk32
        mkdir -p ~/.steam/config

    - name: Decode Steam Config
      env:
        STEAM_CONFIG_VDF: ${{ secrets.STEAM_CONFIGVDF }}
      run: |
        echo "$STEAM_CONFIG_VDF" | base64 --decode > ~/.steam/config/config.vdf

    - name: Update Workshop Item
      run: |
        ~/steamcmd/steamcmd.sh +login ${{ secrets.STEAM_USERNAME }} ${{ secrets.STEAM_PASSWORD }} +workshop_build_item ${{ github.workspace }}/SteamWorkshopFiles/workshop.vdf +quit
      working-directory: ${{ github.workspace }}